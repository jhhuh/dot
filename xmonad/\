import XMonad
import XMonad.Config.Desktop (desktopConfig)

import XMonad.Hooks.DynamicLog (xmobar, dynamicLogString, xmonadPropLog)

import XMonad.Prompt.Shell (shellPrompt)
import XMonad.Prompt.Ssh (sshPrompt)
import XMonad.Util.NamedScratchpad ( namedScratchpadAction
                                   , namedScratchpadManageHook
                                   , customFloating
                                   , NamedScratchpad (NS) )

import qualified XMonad.StackSet as W

import XMonad.Util.Run (spawnPipe)

import qualified Data.Map as M
import qualified Data.Char as C

main = do spawn "~/.xmonad/xmobar.sh ~/.xmonad/xmobar.hs"
          xmonad conf
  where

    conf = desktopConfig { borderWidth = 2
                         , terminal = "urxvt"
                         , modMask = mod4Mask
                         , keys = myKeys <+> keys desktopConfig
                         , manageHook = scratchpadHook <+> manageHook desktopConfig <+> myManageHook
                         , startupHook = spawn "xset r rate 250 50; feh --bg-scale ~/wallpaper/artistic-wallpaper-photo-inverted.jpg"
                         , logHook = dynamicLogString def >>= xmonadPropLog
                         }
    scratchpads = let
        makeNS (name,cmd,px,py,w,h) = NS name (terminalCmd++cmd) (title =? name) (customFloating $ W.RationalRect px py w h)
        terminalCmd = "urxvt -fn \"xft:Bitstream Vera Sans Mono:pixelsize=11\" -rv -e "
      in
      map makeNS [
        ( "alsamixer",    "alsamixer",           3/8,  3/8, 1/4,  1/4 ),
        ( "htop",         "htop",                1/12, 1/6, 5/12, 2/3 ),
        ( "vimpc",        "vimpc",               1/2,  1/6, 5/12, 2/3 ),
        ( "ranger",       "ranger",              1/6,  1/6, 2/3,  2/3 ),
        ( "nixpkgs", "ranger", 2/3,  5/6, 1/3,  1/6 ) ]

    myKeys XConfig { modMask = modm } =
      M.fromList [ ((modm, xK_p), shellPrompt def)
                 , ((modm .|. controlMask, xK_i), spawn "xcalib -i -a")
                 , ((modm .|. controlMask, xK_s), sshPrompt def)
                 , ((modm .|. controlMask, xK_h), namedScratchpadAction scratchpads "htop")
                 , ((modm .|. controlMask, xK_m), namedScratchpadAction scratchpads "vimpc")
                 , ((modm .|. controlMask, xK_space), namedScratchpadAction scratchpads "ranger")
                 , ((modm .|. controlMask, xK_n), namedScratchpadAction scratchpads "nixpkgs")
                 , ((modm .|. controlMask, xK_v), namedScratchpadAction scratchpads "alsamixer")
                 ]

    scratchpadHook = namedScratchpadManageHook scratchpads

    myManageHook = composeAll . concat $
      [ [ className   =? c --> doFloat           | c <- myFloatsByClass ]
      , [ title       =? t --> doFloat           | t <- myFloatsByTitle ]
     -- , [ className   =? c --> doF (W.shift "2") | c <- webApps ]
      ]
      where myFloatsByClass = concatMap (\s -> [ s, capitalize s ]) []
            myFloatsByTitle = [ "Open Document" ]
            webApps         = [ "" ]

    capitalize :: String -> String
    capitalize (c:cs) = C.toUpper c : cs
    capitalize [] = []
